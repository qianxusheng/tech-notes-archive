
# 计算机网络

## 主机之间的通信方式
- C/S（客户端/服务器）
- P2P（对等网络）

## 基本概念
- **ISP**：Internet Service Provider（互联网服务提供商）
- **Internet**：网络的网络
- **电路交换 vs 分组交换**  
  - 电路交换：需要专用物理链路，利用率低  
  - 分组交换：同一传输线路允许多个分组传输，利用率高  

## 路由时延
路由时延 = 排队时延 + 处理时延 + 传输时延 + 传播时延  
- **排队时延**：等待路由器处理  
- **处理时延**：路由器分析IP头部  
- **传输时延**：数据帧变为比特流推到物理层  
- **传播时延**：电磁波在信道中传播的时间  

---

## 网络模型
### OSI七层模型
| 层         | 功能                               | 传输单位   | 设备/协议          |
|------------|------------------------------------|------------|--------------------|
| 物理层     | 传输比特流                         | 比特bitstream     | 光纤、电缆         |
| 数据链路层 | 传输帧，差错检测                   | 帧frame         | 交换机、网卡       |
| 网络层     | 路由选择，IP寻址                   | 数据报datagram     | 路由器             |
| 传输层     | 进程间通信，可靠传输               | 报文段segment     | TCP/UDP            |
| 会话层     | 建立和管理会话                     | -          | -                  |
| 表示层     | 数据压缩、加密、编码               | -          | -                  |
| 应用层     | 为应用程序提供通信服务             | 报文Message       | HTTP、DNS、FTP     |

### TCP/IP五层协议
- 物理层  
- 数据链路层  
- 网络层（IP协议）  
- 传输层（TCP/UDP）  
- 应用层（HTTP、FTP等）  

---

## 各层详解
### 1. 物理层
- **通信方式**：  
  - 单工通信（单向）  
  - 半双工通信（交替传输）  
  - 全双工通信（同时传输）  
- **带通调制**：将数字信号转换为模拟信号传输  
- **重点**：数字信号的调制解调；硬件：光纤等物理传输设备

### 2. 数据链路层（局域网，负责一段链路上的转发）
- **功能**：  
  - 帧封装（首尾部标记帧边界）首部尾部，标记开始和结束位置
  - 透明传输（转义字符处理）如果frame的数据部分包含首部或尾部的内容，就插入转义字符；如果数据包含转义字符本身，就双重转义（再插入一个转义字符）；
  - 差错检测（CRC循环冗余检验）确保数据链路层传输的准确性（因为数据会在不同链路上传输，减少局部物理链路上的差错）  
- **信道分类**：  
  - 广播信道（CSMA/CD协议、信道复用技术）  
  - 点对点（PPP协议）  
- **MAC地址**：标识网络适配器（如网卡地址）  
- **局域网（LAN）**：典型广播信道  
- **虚拟局域网（VLAN）**：逻辑组，与物理位置无关  
- **Ethernet协议**：包含MAC地址、源地址等字段的帧  
- **重点**：局域网，链路层负责在局域网内信息的转发；查询MAC地址表，转发给目标设备；对应硬件设备：交换机，路由器，网卡（笔记本的无线和有线网卡，所以笔记本一般两个MAC地址）

### 3. 网络层（不同链路层的转发，目的地是链路层的路由器）
- **核心功能**：  
  - 提供IP数据报服务（尽最大努力交付）  
  - 连接异构网络，实现统一寻址（使用IP协议，将异构的物理网络连接起来，使得看起来好像是一个统一的网络）
  - 主机间通信，主机拿到数据！！~把路由器也当转发的主机吧。。
- **IP分片**：适应数据链路层最大传输限制  
- **IP数据报格式**：  
  - 版本(internet protocol version)、总长度（首部+数据部分）、TTL（TTL，time to live，放弃在internet中无法交付的datagram）、协议字段（上交给哪个协议处理，TCP/UDP）、首部校验和（因为每经过一个路由器都要计算，所以单独拎出，减少计算工作量）、标识符（datagram分片标识）、片偏移（和标识符一起定位分片起始位置） 
- **IP地址编址**：  
  - 分类（A/B/C/D/E类）网络号+主机号  
  - 子网划分（子网掩码）主机号拿一部分作为子网号，需要配置子网掩码
  - 无分类（CIDR，如`128.14.35.7/20`） IP地址+网络前缀表示法
- **关键协议**：  
  - **ARP**：根据目的IP查询目的MAC地址。链路层封装frame需要目的MAC地址，这个地址需要在网络层获得。
  - **ICMP**：差错报告（如`ping`）  
  - **VPN**：通过公网建立私有逻辑网络。局域网内部设备能够穿过公网，与远端专用网络（局域网，LAN，local area network）建立连接，安全隐私；专用的VPN服务器（逻辑网络）
  - **NAT**：私有IP映射到公网IP。路由器通过NAT将局域网内部多个私有IP映射到同一公网IP上，从而访问公网
- **重点**：网络！！最大可能交付，不同链路之间的传递路由，通过路由器的路由表以及路由算法（Dijkstra）决定下一跳地址；硬件设备：路由器
  
### 4. 传输层
- **功能**：进程间通信，屏蔽底层细节，使得应用程序看起来像两个传输层实体之间有一条端到端的逻辑通信信道一样。想象两台电脑，两个QQ进程在通信，不过只是进程拿到数据，需要通过应用程序处理哟。
- **UDP**：  
  - 无连接、尽最大努力交付、适合要求快速的多对多通信
  - 首部仅8字节（源/目的端口、长度、校验和）  
- **TCP**：  
  - 可靠传输（三次握手、四次挥手、超时重传、流量控制、拥塞控制）  
  - 面向字节流，通过滑动窗口控制发送速率
  - 可以通过MSS最大报文长度提前控制TCP报文段的大小，从而减少网络层IP分片次数（还记得吗，链路层的最大传输限制，所以IP数据报要分片，而且在网络层很凶险，分片掉了就要重传，被乱车创死！--这里我们假设TCP所以需要重传，UDP就直接不要了）
  - 首部字段：序号（传输字节序列的唯一标识符，例如1000就表示传输初始位置1000）、确认号（表示接收方期待接收的下一个字节的序号，比如我收到了1000个字节的数据，并且知道发送方的序号是1000，那么确认号就是2001，表示我下一次期待2001为开始序号的字节序列；接收方可以通过确认号确认，因为他确实是发送了1000个字节，所以接收方期待下一个字节的序号确实应该是2001）、ACK/SYN/FIN标志位、窗口大小、数据偏移（TCP首部长度）、选项（如MSS）  
- **TCP三次握手**：  
  1. A→B：SYN=1, seq=x  
  2. B→A：SYN=1, ACK=1, ack=x+1, seq=y  
  3. A→B：ACK=1, ack=y+1, seq=x+1  
TCP三次握手：A向B发送连接请求，ACK=0，SYN=1，seq=x（B确认A的发送能力）；B向A确认连接SYN=1，ACK=1，ack=x+1，seq=y（A确认B的收发能力）；A向B确认连接（B确认A的接收能力）seq=x+1，ack=y+1。重复强调！seq告诉接收方自己当前信息的初始seq位置，接收方就能根据序号组装数据，ack向接收方确认自己收到了ack之前的字节序号，下一步需要y+1的字节序号。
第三次挥手：第三次挥手避免旧的连接请求。
- **TCP四次挥手**：  
  1. A→B：FIN=1, seq=u  
  2. B→A：ACK=1, ack=u+1  
  3. B→A：FIN=1, seq=w, ack=u+1  
  4. A→B：ACK=1, ack=w+1
TCP四次挥手：A发送连接释放报文（表示信息已全部传输），FIN=1，seq=u；B收到后确认，TCP半关闭，B仍在传输剩余数据seq=v，ack=u+1；B不需要连接，发送释放报文，FIN=1，seq=w（因为B还在发数据，所以自己的seq会增长），ack=u+1；A收到后给B发送确认报文，seq=u+1，ack=w+1，同时A进入time-wait状态（确认最后一个报文已送达，如果B没收到可能会重新发送连接释放请求报文；同时确保老的TPC报文消失，新连接不会有遗留数据）
- **TCP可靠传输**： 
超时重传：超时重传：超时重传  
滑动窗口：已发送且已确认（收到ACK，可释放缓存，可滑动窗口）；已发送未确认；可以发送但未发送；窗口外的数据不能发，等待窗口滑动；窗口就是缓存的一部分，用来暂时存放字节流；通过序列号，确认号和窗口大小实现  
流量控制：控制发送方的发送速率，确保接收方来得及接收  
拥塞控制：网络拥堵分组将会丢失，此时发送方需要重传，从而导致网络拥堵程度更高；TCP通过慢开始，拥塞避免，快重传，快恢复4个算法降低整个网络的拥塞程度 
- **重点**：端口：每个进程都有唯一的标识符，端口号，是一个逻辑概念，用于标识不同应用程序之间的通信
  
### 5. 应用层
- **DNS**：域名与IP转换（端口53，UDP/TCP）  
- **DHCP**：动态分配IP（端口67/68，UDP）  
- **FTP**：文件传输（端口20/21，TCP）  
- **HTTP**：网页浏览（端口80，TCP）  
- **SMTP/POP3/IMAP**：电子邮件（端口25/110/143，TCP）  
- **重点**：DNS和HTTP比较常见

## 常见协议与端口
| 应用            | 协议   | 端口号   | 传输层协议 | 备注                     |
|-----------------|--------|----------|------------|--------------------------|
| 域名解析        | DNS    | 53       | UDP/TCP    | 长度>512字节时用TCP      |
| 动态主机配置    | DHCP   | 67/68    | UDP        |                          |
| 文件传输        | FTP    | 20/21    | TCP        | 控制21，数据20           |
| 远程终端        | TELNET | 23       | TCP        |                          |
| 超文本传输      | HTTP   | 80       | TCP        |                          |
| 简单邮件传输    | SMTP   | 25       | TCP        |                          |
| 邮件读取        | POP3   | 110      | TCP        |                          |
| 网际报文存取    | IMAP   | 143      | TCP        |                          |

-**路由器**：路由器很重要，一般负责路由+交换机两个功能；IP数据报在多次路由的过程中，就是在网络层和链路层反复解包和封装，比如说此时我知道了下一跳目的IP地址，我还需要目的MAC地址去封装frame，然后物理层传输，然后到达目的地，链路层解包（就一直当路由器吧，哈哈，还是我路由器，路由器一看MAC地址，OK是给我的，然后解包成IP数据报，OK还不是地址IP，还要转发，对下一跳IP发起ARP请求，得到ARP，如此循环往复；直到某事某刻，路由器一看IP在本地，查本地ARP缓存表，表中只有本地MAC地址哦，然后根据表中MAC地址转发给目标主机，网络层实现的主机之间的通信就结束了，然后传输层端口进去，如果是网页就是80端口，某进程访问到80端口，应用程序根据数据渲染网页）；我想强调的其实是底层的反复工作比较多，顶层可能就是丢包了重传可能会重复几次，PS：终于知道小时候听到的丢包是什么意思了。
